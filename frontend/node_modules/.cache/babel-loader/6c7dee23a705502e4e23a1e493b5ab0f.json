{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nvar _jsxFileName = \"/Users/nikitajethani/Desktop/cs-4530-covey/frontend/src/App.tsx\",\n    _s = $RefreshSig$(),\n    _s2 = $RefreshSig$();\n\nimport React, { useCallback, useEffect, useMemo, useReducer, useState } from 'react';\nimport './App.css';\nimport { BrowserRouter } from 'react-router-dom';\nimport { io } from 'socket.io-client';\nimport { ChakraProvider } from '@chakra-ui/react';\nimport { MuiThemeProvider } from '@material-ui/core/styles';\nimport assert from 'assert';\nimport WorldMap from './components/world/WorldMap';\nimport VideoOverlay from './components/VideoCall/VideoOverlay/VideoOverlay';\nimport VideoContext from './contexts/VideoContext';\nimport Login from './components/Login/Login';\nimport CoveyAppContext from './contexts/CoveyAppContext';\nimport NearbyPlayersContext from './contexts/NearbyPlayersContext';\nimport AppStateProvider, { useAppState } from './components/VideoCall/VideoFrontend/state';\nimport useConnectionOptions from './components/VideoCall/VideoFrontend/utils/useConnectionOptions/useConnectionOptions';\nimport UnsupportedBrowserWarning from './components/VideoCall/VideoFrontend/components/UnsupportedBrowserWarning/UnsupportedBrowserWarning';\nimport { VideoProvider } from './components/VideoCall/VideoFrontend/components/VideoProvider';\nimport ErrorDialog from './components/VideoCall/VideoFrontend/components/ErrorDialog/ErrorDialog';\nimport theme from './components/VideoCall/VideoFrontend/theme';\nimport Player from './classes/Player';\nimport TownsServiceClient from './classes/TownsServiceClient';\nimport Video from './classes/Video/Video';\n\nfunction defaultAppState() {\n  return {\n    nearbyPlayers: {\n      nearbyPlayers: []\n    },\n    // my edits\n    messageHistory: {\n      messageHistory: []\n    },\n    players: [],\n    myPlayerID: '',\n    currentTownFriendlyName: '',\n    currentTownID: '',\n    currentTownIsPubliclyListed: false,\n    sessionToken: '',\n    userName: '',\n    socket: null,\n    currentLocation: {\n      x: 0,\n      y: 0,\n      rotation: 'front',\n      moving: false\n    },\n    emitMovement: () => {},\n    apiClient: new TownsServiceClient()\n  };\n}\n\nfunction appStateReducer(state, update) {\n  var _state$socket;\n\n  const nextState = {\n    sessionToken: state.sessionToken,\n    currentTownFriendlyName: state.currentTownFriendlyName,\n    currentTownID: state.currentTownID,\n    currentTownIsPubliclyListed: state.currentTownIsPubliclyListed,\n    myPlayerID: state.myPlayerID,\n    // my edit\n    messageHistory: state.messageHistory,\n    players: state.players,\n    currentLocation: state.currentLocation,\n    nearbyPlayers: state.nearbyPlayers,\n    userName: state.userName,\n    socket: state.socket,\n    emitMovement: state.emitMovement,\n    apiClient: state.apiClient\n  };\n\n  function calculateNearbyPlayers(players, currentLocation) {\n    const isWithinCallRadius = (p, location) => {\n      if (p.location && location) {\n        const dx = p.location.x - location.x;\n        const dy = p.location.y - location.y;\n        const d = Math.sqrt(dx * dx + dy * dy);\n        return d < 80;\n      }\n\n      return false;\n    };\n\n    return {\n      nearbyPlayers: players.filter(p => isWithinCallRadius(p, currentLocation))\n    };\n  }\n\n  function samePlayers(a1, a2) {\n    if (a1.nearbyPlayers.length !== a2.nearbyPlayers.length) return false;\n    const ids1 = a1.nearbyPlayers.map(p => p.id).sort();\n    const ids2 = a2.nearbyPlayers.map(p => p.id).sort();\n    return !ids1.some((val, idx) => val !== ids2[idx]);\n  }\n\n  let updatePlayer;\n\n  switch (update.action) {\n    case 'doConnect':\n      nextState.sessionToken = update.data.sessionToken;\n      nextState.myPlayerID = update.data.myPlayerID;\n      nextState.currentTownFriendlyName = update.data.townFriendlyName;\n      nextState.currentTownID = update.data.townID;\n      nextState.currentTownIsPubliclyListed = update.data.townIsPubliclyListed;\n      nextState.userName = update.data.userName;\n      nextState.emitMovement = update.data.emitMovement;\n      nextState.socket = update.data.socket;\n      nextState.players = update.data.players;\n      nextState.messageHistory = update.data.messageHistory;\n      break;\n\n    case 'addPlayer':\n      nextState.players = nextState.players.concat([update.player]);\n      break;\n\n    case 'playerMoved':\n      updatePlayer = nextState.players.find(p => p.id === update.player.id);\n\n      if (updatePlayer) {\n        updatePlayer.location = update.player.location;\n      } else {\n        nextState.players = nextState.players.concat([update.player]);\n      }\n\n      nextState.nearbyPlayers = calculateNearbyPlayers(nextState.players, nextState.currentLocation);\n\n      if (samePlayers(nextState.nearbyPlayers, state.nearbyPlayers)) {\n        nextState.nearbyPlayers = state.nearbyPlayers;\n      }\n\n      break;\n\n    case 'weMoved':\n      nextState.currentLocation = update.location;\n      nextState.nearbyPlayers = calculateNearbyPlayers(nextState.players, nextState.currentLocation);\n\n      if (samePlayers(nextState.nearbyPlayers, state.nearbyPlayers)) {\n        nextState.nearbyPlayers = state.nearbyPlayers;\n      }\n\n      break;\n\n    case 'playerDisconnect':\n      nextState.players = nextState.players.filter(player => player.id !== update.player.id);\n      nextState.nearbyPlayers = calculateNearbyPlayers(nextState.players, nextState.currentLocation);\n\n      if (samePlayers(nextState.nearbyPlayers, state.nearbyPlayers)) {\n        nextState.nearbyPlayers = state.nearbyPlayers;\n      }\n\n      break;\n\n    case 'disconnect':\n      (_state$socket = state.socket) === null || _state$socket === void 0 ? void 0 : _state$socket.disconnect();\n      return defaultAppState();\n\n    default:\n      throw new Error('Unexpected state request');\n    // my edits\n\n    case 'publicMessage':\n      nextState.messageHistory.messageHistory.push({\n        type: 'outgoing',\n        privacy: 'public',\n        from: 'Me',\n        to: 'Everyone',\n        message: update.message,\n        seen: false\n      });\n      break;\n    // case 'publicMessage':\n    //   if (update.fromPlayer.id === state.myPlayerID) {\n    //     nextState.messageHistory.messageHistory.push({ type: 'outgoing', privacy: 'public', from: 'Me', to: 'Everyone', message: update.message, seen: false});\n    //   } else {\n    //     nextState.messageHistory.messageHistory.push({ type: 'incoming', privacy: 'public', from: update.fromPlayer.userName, to: 'Everyone', message: update.message, seen: false});\n    //   }\n    //   break;\n\n    case 'privateMessage':\n      if (update.fromPlayer.id === state.myPlayerID) {\n        nextState.messageHistory.messageHistory.push({\n          type: 'outgoing',\n          privacy: 'private',\n          from: 'Me',\n          to: update.toPlayer.userName,\n          message: update.message,\n          seen: false\n        });\n      } else {\n        nextState.messageHistory.messageHistory.push({\n          type: 'incoming',\n          privacy: 'private',\n          from: update.fromPlayer.userName,\n          to: 'Me',\n          message: update.message,\n          seen: false\n        });\n      }\n\n      break;\n  }\n\n  return nextState;\n}\n\nasync function GameController(initData, dispatchAppUpdate) {\n  // Now, set up the game sockets\n  const gamePlayerID = initData.coveyUserID;\n  const sessionToken = initData.coveySessionToken;\n  const url = process.env.REACT_APP_TOWNS_SERVICE_URL;\n  assert(url);\n  const video = Video.instance();\n  assert(video);\n  const roomName = video.townFriendlyName;\n  assert(roomName);\n  const socket = io(url, {\n    auth: {\n      token: sessionToken,\n      coveyTownID: video.coveyTownID\n    }\n  });\n  socket.on('newPlayer', player => {\n    dispatchAppUpdate({\n      action: 'addPlayer',\n      player: Player.fromServerPlayer(player)\n    });\n  });\n  socket.on('playerMoved', player => {\n    if (player._id !== gamePlayerID) {\n      dispatchAppUpdate({\n        action: 'playerMoved',\n        player: Player.fromServerPlayer(player)\n      });\n    }\n  });\n  socket.on('playerDisconnect', player => {\n    dispatchAppUpdate({\n      action: 'playerDisconnect',\n      player: Player.fromServerPlayer(player)\n    });\n  });\n  socket.on('disconnect', () => {\n    dispatchAppUpdate({\n      action: 'disconnect'\n    });\n  });\n\n  const emitMovement = location => {\n    socket.emit('playerMovement', location);\n    dispatchAppUpdate({\n      action: 'weMoved',\n      location\n    });\n  }; // my edit\n  // socket.onmes\n\n\n  socket.on('message', messageSent => {\n    console.log(messageSent); // dispatchAppUpdate({ action: 'publicMessage', message: messageSent});\n  }); // socket.on('publicMessage', (messageSent: string, player: ServerPlayer) => {\n  //   dispatchAppUpdate({ action: 'publicMessage', message: messageSent, fromPlayer: Player.fromServerPlayer(player) });\n  // });\n\n  socket.on('privateMessage', (messageSent, fplayer, tplayer) => {\n    dispatchAppUpdate({\n      action: 'privateMessage',\n      message: messageSent,\n      fromPlayer: Player.fromServerPlayer(fplayer),\n      toPlayer: Player.fromServerPlayer(tplayer)\n    });\n  });\n  dispatchAppUpdate({\n    action: 'doConnect',\n    data: {\n      sessionToken,\n      userName: video.userName,\n      townFriendlyName: roomName,\n      townID: video.coveyTownID,\n      myPlayerID: gamePlayerID,\n      townIsPubliclyListed: video.isPubliclyListed,\n      emitMovement,\n      socket,\n      players: initData.currentPlayers.map(sp => Player.fromServerPlayer(sp)),\n      messageHistory: {\n        messageHistory: []\n      }\n    }\n  });\n  return true;\n}\n\n_c = GameController;\n\nfunction App(props) {\n  _s();\n\n  const [appState, dispatchAppUpdate] = useReducer(appStateReducer, defaultAppState());\n  const setupGameController = useCallback(async initData => {\n    await GameController(initData, dispatchAppUpdate);\n    return true;\n  }, [dispatchAppUpdate]);\n  const videoInstance = Video.instance();\n  const {\n    setOnDisconnect\n  } = props;\n  useEffect(() => {\n    setOnDisconnect(() => async () => {\n      // Here's a great gotcha: https://medium.com/swlh/how-to-store-a-function-with-the-usestate-hook-in-react-8a88dd4eede1\n      dispatchAppUpdate({\n        action: 'disconnect'\n      });\n      return Video.teardown();\n    });\n  }, [dispatchAppUpdate, setOnDisconnect]);\n  const page = useMemo(() => {\n    if (!appState.sessionToken) {\n      return /*#__PURE__*/_jsxDEV(Login, {\n        doLogin: setupGameController\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 269,\n        columnNumber: 14\n      }, this);\n    }\n\n    if (!videoInstance) {\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        children: \"Loading...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 271,\n        columnNumber: 14\n      }, this);\n    }\n\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(WorldMap, {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 275,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(VideoOverlay, {\n        preferredMode: \"fullwidth\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 276,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 274,\n      columnNumber: 7\n    }, this);\n  }, [setupGameController, appState.sessionToken, videoInstance]);\n  return /*#__PURE__*/_jsxDEV(CoveyAppContext.Provider, {\n    value: appState,\n    children: /*#__PURE__*/_jsxDEV(VideoContext.Provider, {\n      value: Video.instance(),\n      children: /*#__PURE__*/_jsxDEV(NearbyPlayersContext.Provider, {\n        value: appState.nearbyPlayers,\n        children: page\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 284,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 283,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 282,\n    columnNumber: 5\n  }, this);\n}\n\n_s(App, \"hlZHenlJOnd4q2CYPlKmw/zwGNA=\");\n\n_c2 = App;\n\nfunction EmbeddedTwilioAppWrapper() {\n  _s2();\n\n  const {\n    error,\n    setError\n  } = useAppState();\n  const [onDisconnect, setOnDisconnect] = useState();\n  const connectionOptions = useConnectionOptions();\n  return /*#__PURE__*/_jsxDEV(UnsupportedBrowserWarning, {\n    children: /*#__PURE__*/_jsxDEV(VideoProvider, {\n      options: connectionOptions,\n      onError: setError,\n      onDisconnect: onDisconnect,\n      children: [/*#__PURE__*/_jsxDEV(ErrorDialog, {\n        dismissError: () => setError(null),\n        error: error\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 300,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(App, {\n        setOnDisconnect: setOnDisconnect\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 301,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 299,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 298,\n    columnNumber: 5\n  }, this);\n}\n\n_s2(EmbeddedTwilioAppWrapper, \"L1gaqrf8YLZNV/J5WP4vEWpalos=\", false, function () {\n  return [useAppState, useConnectionOptions];\n});\n\n_c3 = EmbeddedTwilioAppWrapper;\nexport default function AppStateWrapper() {\n  return /*#__PURE__*/_jsxDEV(BrowserRouter, {\n    children: /*#__PURE__*/_jsxDEV(ChakraProvider, {\n      children: /*#__PURE__*/_jsxDEV(MuiThemeProvider, {\n        theme: theme('rgb(185, 37, 0)'),\n        children: /*#__PURE__*/_jsxDEV(AppStateProvider, {\n          preferredMode: \"fullwidth\",\n          highlightedProfiles: [],\n          children: /*#__PURE__*/_jsxDEV(EmbeddedTwilioAppWrapper, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 313,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 312,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 311,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 310,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 309,\n    columnNumber: 5\n  }, this);\n}\n_c4 = AppStateWrapper;\n\nvar _c, _c2, _c3, _c4;\n\n$RefreshReg$(_c, \"GameController\");\n$RefreshReg$(_c2, \"App\");\n$RefreshReg$(_c3, \"EmbeddedTwilioAppWrapper\");\n$RefreshReg$(_c4, \"AppStateWrapper\");","map":{"version":3,"sources":["/Users/nikitajethani/Desktop/cs-4530-covey/frontend/src/App.tsx"],"names":["React","useCallback","useEffect","useMemo","useReducer","useState","BrowserRouter","io","ChakraProvider","MuiThemeProvider","assert","WorldMap","VideoOverlay","VideoContext","Login","CoveyAppContext","NearbyPlayersContext","AppStateProvider","useAppState","useConnectionOptions","UnsupportedBrowserWarning","VideoProvider","ErrorDialog","theme","Player","TownsServiceClient","Video","defaultAppState","nearbyPlayers","messageHistory","players","myPlayerID","currentTownFriendlyName","currentTownID","currentTownIsPubliclyListed","sessionToken","userName","socket","currentLocation","x","y","rotation","moving","emitMovement","apiClient","appStateReducer","state","update","nextState","calculateNearbyPlayers","isWithinCallRadius","p","location","dx","dy","d","Math","sqrt","filter","samePlayers","a1","a2","length","ids1","map","id","sort","ids2","some","val","idx","updatePlayer","action","data","townFriendlyName","townID","townIsPubliclyListed","concat","player","find","disconnect","Error","push","type","privacy","from","to","message","seen","fromPlayer","toPlayer","GameController","initData","dispatchAppUpdate","gamePlayerID","coveyUserID","coveySessionToken","url","process","env","REACT_APP_TOWNS_SERVICE_URL","video","instance","roomName","auth","token","coveyTownID","on","fromServerPlayer","_id","emit","messageSent","console","log","fplayer","tplayer","isPubliclyListed","currentPlayers","sp","App","props","appState","setupGameController","videoInstance","setOnDisconnect","teardown","page","EmbeddedTwilioAppWrapper","error","setError","onDisconnect","connectionOptions","AppStateWrapper"],"mappings":"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","sourcesContent":["import React, {\n  Dispatch, SetStateAction, useCallback, useEffect, useMemo, useReducer, useState,\n} from 'react';\nimport './App.css';\nimport { BrowserRouter } from 'react-router-dom';\nimport { io, Socket } from 'socket.io-client';\nimport { ChakraProvider } from '@chakra-ui/react';\nimport { MuiThemeProvider } from '@material-ui/core/styles';\nimport assert from 'assert';\nimport WorldMap from './components/world/WorldMap';\nimport VideoOverlay from './components/VideoCall/VideoOverlay/VideoOverlay';\nimport { CoveyAppState, NearbyPlayers, MessageHistory } from './CoveyTypes';\nimport VideoContext from './contexts/VideoContext';\nimport Login from './components/Login/Login';\nimport CoveyAppContext from './contexts/CoveyAppContext';\nimport NearbyPlayersContext from './contexts/NearbyPlayersContext';\nimport AppStateProvider, { useAppState } from './components/VideoCall/VideoFrontend/state';\nimport useConnectionOptions from './components/VideoCall/VideoFrontend/utils/useConnectionOptions/useConnectionOptions';\nimport UnsupportedBrowserWarning\n  from './components/VideoCall/VideoFrontend/components/UnsupportedBrowserWarning/UnsupportedBrowserWarning';\nimport { VideoProvider } from './components/VideoCall/VideoFrontend/components/VideoProvider';\nimport ErrorDialog from './components/VideoCall/VideoFrontend/components/ErrorDialog/ErrorDialog';\nimport theme from './components/VideoCall/VideoFrontend/theme';\nimport { Callback } from './components/VideoCall/VideoFrontend/types';\nimport Player, { ServerPlayer, UserLocation } from './classes/Player';\nimport TownsServiceClient, { TownJoinResponse } from './classes/TownsServiceClient';\nimport Video from './classes/Video/Video';\n\ntype CoveyAppUpdate =\n  | { action: 'doConnect'; data: { userName: string, townFriendlyName: string, townID: string,townIsPubliclyListed:boolean, sessionToken: string, myPlayerID: string, socket: Socket, players: Player[], emitMovement: (location: UserLocation) => void, messageHistory: MessageHistory} }\n  | { action: 'addPlayer'; player: Player }\n  | { action: 'playerMoved'; player: Player }\n  | { action: 'playerDisconnect'; player: Player }\n  | { action: 'weMoved'; location: UserLocation }\n  | { action: 'disconnect' }\n  // my edits\n  | {action: 'publicMessage'; message: string}\n\n  // | {action: 'publicMessage'; message: string; fromPlayer: Player}\n  | {action: 'privateMessage'; message: string; fromPlayer: Player, toPlayer: Player}\n  ;\n\nfunction defaultAppState(): CoveyAppState {\n  return {\n    nearbyPlayers: { nearbyPlayers: [] },\n    // my edits\n    messageHistory: { messageHistory: [] },\n\n    players: [],\n    myPlayerID: '',\n    currentTownFriendlyName: '',\n    currentTownID: '',\n    currentTownIsPubliclyListed: false,\n    sessionToken: '',\n    userName: '',\n    socket: null,\n    currentLocation: {\n      x: 0, y: 0, rotation: 'front', moving: false,\n    },\n    emitMovement: () => {\n    },\n    apiClient: new TownsServiceClient(),\n  };\n}\nfunction appStateReducer(state: CoveyAppState, update: CoveyAppUpdate): CoveyAppState {\n  const nextState = {\n    sessionToken: state.sessionToken,\n    currentTownFriendlyName: state.currentTownFriendlyName,\n    currentTownID: state.currentTownID,\n    currentTownIsPubliclyListed: state.currentTownIsPubliclyListed,\n    myPlayerID: state.myPlayerID,\n\n    // my edit\n    messageHistory: state.messageHistory,\n    players: state.players,\n    currentLocation: state.currentLocation,\n    nearbyPlayers: state.nearbyPlayers,\n    userName: state.userName,\n    socket: state.socket,\n    emitMovement: state.emitMovement,\n    apiClient: state.apiClient,\n  };\n\n  function calculateNearbyPlayers(players: Player[], currentLocation: UserLocation) {\n    const isWithinCallRadius = (p: Player, location: UserLocation) => {\n      if (p.location && location) {\n        const dx = p.location.x - location.x;\n        const dy = p.location.y - location.y;\n        const d = Math.sqrt(dx * dx + dy * dy);\n        return d < 80;\n      }\n      return false;\n    };\n    return { nearbyPlayers: players.filter((p) => isWithinCallRadius(p, currentLocation)) };\n  }\n\n  function samePlayers(a1: NearbyPlayers, a2: NearbyPlayers) {\n    if (a1.nearbyPlayers.length !== a2.nearbyPlayers.length) return false;\n    const ids1 = a1.nearbyPlayers.map((p) => p.id).sort();\n    const ids2 = a2.nearbyPlayers.map((p) => p.id).sort();\n    return !ids1.some((val, idx) => val !== ids2[idx]);\n  }\n\n  let updatePlayer;\n  switch (update.action) {\n    case 'doConnect':\n      nextState.sessionToken = update.data.sessionToken;\n      nextState.myPlayerID = update.data.myPlayerID;\n      nextState.currentTownFriendlyName = update.data.townFriendlyName;\n      nextState.currentTownID = update.data.townID;\n      nextState.currentTownIsPubliclyListed = update.data.townIsPubliclyListed;\n      nextState.userName = update.data.userName;\n      nextState.emitMovement = update.data.emitMovement;\n      nextState.socket = update.data.socket;\n      nextState.players = update.data.players;\n      nextState.messageHistory = update.data.messageHistory;\n      break;\n    case 'addPlayer':\n      nextState.players = nextState.players.concat([update.player]);\n      break;\n    case 'playerMoved':\n      updatePlayer = nextState.players.find((p) => p.id === update.player.id);\n      if (updatePlayer) {\n        updatePlayer.location = update.player.location;\n      } else {\n        nextState.players = nextState.players.concat([update.player]);\n      }\n      nextState.nearbyPlayers = calculateNearbyPlayers(nextState.players,\n        nextState.currentLocation);\n      if (samePlayers(nextState.nearbyPlayers, state.nearbyPlayers)) {\n        nextState.nearbyPlayers = state.nearbyPlayers;\n      }\n      break;\n    case 'weMoved':\n      nextState.currentLocation = update.location;\n      nextState.nearbyPlayers = calculateNearbyPlayers(nextState.players,\n        nextState.currentLocation);\n      if (samePlayers(nextState.nearbyPlayers, state.nearbyPlayers)) {\n        nextState.nearbyPlayers = state.nearbyPlayers;\n      }\n\n      break;\n    case 'playerDisconnect':\n      nextState.players = nextState.players.filter((player) => player.id !== update.player.id);\n\n      nextState.nearbyPlayers = calculateNearbyPlayers(nextState.players,\n        nextState.currentLocation);\n      if (samePlayers(nextState.nearbyPlayers, state.nearbyPlayers)) {\n        nextState.nearbyPlayers = state.nearbyPlayers;\n      }\n      break;\n    case 'disconnect':\n      state.socket?.disconnect();\n      return defaultAppState();\n    default:\n      throw new Error('Unexpected state request');\n\n    // my edits\n    case 'publicMessage':\n      nextState.messageHistory.messageHistory.push({ type: 'outgoing', privacy: 'public', from: 'Me', to: 'Everyone', message: update.message, seen: false});\n      break;\n    // case 'publicMessage':\n    //   if (update.fromPlayer.id === state.myPlayerID) {\n    //     nextState.messageHistory.messageHistory.push({ type: 'outgoing', privacy: 'public', from: 'Me', to: 'Everyone', message: update.message, seen: false});\n    //   } else {\n    //     nextState.messageHistory.messageHistory.push({ type: 'incoming', privacy: 'public', from: update.fromPlayer.userName, to: 'Everyone', message: update.message, seen: false});\n    //   }\n    //   break;\n    case 'privateMessage': \n      if (update.fromPlayer.id === state.myPlayerID) {\n        nextState.messageHistory.messageHistory.push({ type: 'outgoing', privacy: 'private', from: 'Me', to: update.toPlayer.userName, message: update.message, seen: false});\n      } else {\n        nextState.messageHistory.messageHistory.push({ type: 'incoming', privacy: 'private', from: update.fromPlayer.userName, to: 'Me', message: update.message, seen: false});\n      }\n      break;\n  }\n\n  return nextState;\n}\n\nasync function GameController(initData: TownJoinResponse,\n  dispatchAppUpdate: (update: CoveyAppUpdate) => void) {\n  // Now, set up the game sockets\n  const gamePlayerID = initData.coveyUserID;\n  const sessionToken = initData.coveySessionToken;\n  const url = process.env.REACT_APP_TOWNS_SERVICE_URL;\n  assert(url);\n  const video = Video.instance();\n  assert(video);\n  const roomName = video.townFriendlyName;\n  assert(roomName);\n\n  const socket = io(url, { auth: { token: sessionToken, coveyTownID: video.coveyTownID } });\n  socket.on('newPlayer', (player: ServerPlayer) => {\n    dispatchAppUpdate({\n      action: 'addPlayer',\n      player: Player.fromServerPlayer(player),\n    });\n  });\n  socket.on('playerMoved', (player: ServerPlayer) => {\n    if (player._id !== gamePlayerID) {\n      dispatchAppUpdate({ action: 'playerMoved', player: Player.fromServerPlayer(player) });\n    }\n  });\n  socket.on('playerDisconnect', (player: ServerPlayer) => {\n    dispatchAppUpdate({ action: 'playerDisconnect', player: Player.fromServerPlayer(player) });\n  });\n  socket.on('disconnect', () => {\n    dispatchAppUpdate({ action: 'disconnect' });\n  });\n  const emitMovement = (location: UserLocation) => {\n    socket.emit('playerMovement', location);\n    dispatchAppUpdate({ action: 'weMoved', location });\n  };\n\n  // my edit\n  // socket.onmes\n\n\n  socket.on('message', (messageSent: string) => {\n    console.log(messageSent);\n    // dispatchAppUpdate({ action: 'publicMessage', message: messageSent});\n  });\n  // socket.on('publicMessage', (messageSent: string, player: ServerPlayer) => {\n  //   dispatchAppUpdate({ action: 'publicMessage', message: messageSent, fromPlayer: Player.fromServerPlayer(player) });\n  // });\n\n  socket.on('privateMessage', (messageSent: string, fplayer: ServerPlayer, tplayer: ServerPlayer) => {\n    dispatchAppUpdate({ action: 'privateMessage', message: messageSent, fromPlayer: Player.fromServerPlayer(fplayer), toPlayer: Player.fromServerPlayer(tplayer) });\n  });\n\n  dispatchAppUpdate({\n    action: 'doConnect',\n    data: {\n      sessionToken,\n      userName: video.userName,\n      townFriendlyName: roomName,\n      townID: video.coveyTownID,\n      myPlayerID: gamePlayerID,\n      townIsPubliclyListed: video.isPubliclyListed,\n      emitMovement,\n      socket,\n      players: initData.currentPlayers.map((sp) => Player.fromServerPlayer(sp)),\n      messageHistory: { messageHistory: [] },\n    },\n  });\n  return true;\n}\n\nfunction App(props: { setOnDisconnect: Dispatch<SetStateAction<Callback | undefined>> }) {\n  const [appState, dispatchAppUpdate] = useReducer(appStateReducer, defaultAppState());\n\n  const setupGameController = useCallback(async (initData: TownJoinResponse) => {\n    await GameController(initData, dispatchAppUpdate);\n    return true;\n  }, [dispatchAppUpdate]);\n  const videoInstance = Video.instance();\n\n  const { setOnDisconnect } = props;\n  useEffect(() => {\n    setOnDisconnect(() => async () => { // Here's a great gotcha: https://medium.com/swlh/how-to-store-a-function-with-the-usestate-hook-in-react-8a88dd4eede1\n      dispatchAppUpdate({ action: 'disconnect' });\n      return Video.teardown();\n    });\n  }, [dispatchAppUpdate, setOnDisconnect]);\n\n  const page = useMemo(() => {\n    if (!appState.sessionToken) {\n      return <Login doLogin={setupGameController} />;\n    } if (!videoInstance) {\n      return <div>Loading...</div>;\n    }\n    return (\n      <div>\n        <WorldMap />\n        <VideoOverlay preferredMode=\"fullwidth\" />\n      </div>\n    );\n  }, [setupGameController, appState.sessionToken, videoInstance]);\n  return (\n\n    <CoveyAppContext.Provider value={appState}>\n      <VideoContext.Provider value={Video.instance()}>\n        <NearbyPlayersContext.Provider value={appState.nearbyPlayers}>\n          {page}\n        </NearbyPlayersContext.Provider>\n      </VideoContext.Provider>\n    </CoveyAppContext.Provider>\n\n  );\n}\n\nfunction EmbeddedTwilioAppWrapper() {\n  const { error, setError } = useAppState();\n  const [onDisconnect, setOnDisconnect] = useState<Callback | undefined>();\n  const connectionOptions = useConnectionOptions();\n  return (\n    <UnsupportedBrowserWarning>\n      <VideoProvider options={connectionOptions} onError={setError} onDisconnect={onDisconnect}>\n        <ErrorDialog dismissError={() => setError(null)} error={error} />\n        <App setOnDisconnect={setOnDisconnect} />\n      </VideoProvider>\n    </UnsupportedBrowserWarning>\n  );\n}\n\nexport default function AppStateWrapper(): JSX.Element {\n  return (\n    <BrowserRouter>\n      <ChakraProvider>\n        <MuiThemeProvider theme={theme('rgb(185, 37, 0)')}>\n          <AppStateProvider preferredMode=\"fullwidth\" highlightedProfiles={[]}>\n            <EmbeddedTwilioAppWrapper />\n          </AppStateProvider>\n        </MuiThemeProvider>\n      </ChakraProvider>\n    </BrowserRouter>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}